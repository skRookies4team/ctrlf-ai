name: AI Server Deploy

on:
  push:
    branches: [ "main" ]  # 메인 브랜치에 코드가 푸시되면 실행

jobs:
  deploy:
    runs-on: self-hosted 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update and Run AI Code
        run: |
          # 1. AI 서버 내 실제 프로젝트 폴더로 이동 (현재 위치 확인 필수)
          cd /home/team4/ctrlf-ai-main || exit
          echo "Current directory: $(pwd)"
          
          # 2. 최신 코드 반영
          git pull origin main
          
          # 3. 가상환경 활성화 및 패키지 설치
          source /home/team4/gemma/bin/activate
          pip install -r requirements.txt
          
          # 4. 서버 실행
          echo "Restarting Uvicorn on port 8080..."
          fuser -k 8080/tcp || true
          
          # 5. 백그라운드 실행 (로그 파일 경로 지정)
          nohup uvicorn app.main:app --host 0.0.0.0 --port 8080 > /home/team4/ctrlf-ai-main/ai_server.log 2>&1 &
          
          echo "Deployment command sent successfully."
