name: Integration Tests

on:
  push:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ KST ì˜¤ì „ 6ì‹œ (UTC 21:00)
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      skip_service_setup:
        description: 'Skip docker compose (services already running)'
        required: false
        default: 'false'
        type: boolean

jobs:
  integration-tests:
    runs-on: self-hosted
    timeout-minutes: 30

    env:
      # GitHub Secretsì—ì„œ ì£¼ìž… (í•„ìˆ˜)
      LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
      RAGFLOW_BASE_URL: ${{ secrets.RAGFLOW_BASE_URL }}
      # ì„ íƒì  í™˜ê²½ë³€ìˆ˜
      MILVUS_HOST: ${{ secrets.MILVUS_HOST }}
      MILVUS_PORT: ${{ secrets.MILVUS_PORT }}
      BACKEND_BASE_URL: ${{ secrets.BACKEND_BASE_URL }}
      # RAGFlow API í‚¤ (í•„ìš” ì‹œ)
      RAGFLOW_API_KEY: ${{ secrets.RAGFLOW_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      # =========================================================================
      # ì˜µì…˜ A: Docker Composeë¡œ RAGFlow + Milvus ê¸°ë™ (ê¶Œìž¥)
      # self-hosted runnerì— docker compose ì„¤ì¹˜ í•„ìš”
      # =========================================================================
      - name: Start services (docker compose)
        if: ${{ inputs.skip_service_setup != 'true' }}
        run: |
          echo "Starting RAGFlow and Milvus services..."

          # docker-compose.ci.yml ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
          if [ -f "docker-compose.ci.yml" ]; then
            docker compose -f docker-compose.ci.yml up -d
            echo "Services started via docker-compose.ci.yml"
          else
            echo "WARN: docker-compose.ci.yml not found"
            echo "Assuming services are already running externally"
          fi

      - name: Wait for services to be ready
        if: ${{ inputs.skip_service_setup != 'true' }}
        run: |
          echo "Waiting for services to be ready..."

          # RAGFlow í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 60ì´ˆ)
          if [ -n "$RAGFLOW_BASE_URL" ]; then
            for i in {1..12}; do
              if curl -sf "$RAGFLOW_BASE_URL/api/health" > /dev/null 2>&1; then
                echo "RAGFlow is ready!"
                break
              fi
              echo "Waiting for RAGFlow... ($i/12)"
              sleep 5
            done
          fi

          # LLM í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 60ì´ˆ)
          if [ -n "$LLM_BASE_URL" ]; then
            for i in {1..12}; do
              if curl -sf "$LLM_BASE_URL/health" > /dev/null 2>&1; then
                echo "LLM is ready!"
                break
              fi
              # /health ì—†ìœ¼ë©´ /v1/models ì‹œë„
              if curl -sf "$LLM_BASE_URL/v1/models" > /dev/null 2>&1; then
                echo "LLM is ready! (via /v1/models)"
                break
              fi
              echo "Waiting for LLM... ($i/12)"
              sleep 5
            done
          fi

      # =========================================================================
      # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ (CI strict)
      # =========================================================================
      - name: Verify required environment variables
        run: |
          echo "=============================================="
          echo "Environment Variable Check (CI Strict Mode)"
          echo "=============================================="

          MISSING=""

          if [ -z "$LLM_BASE_URL" ]; then
            echo "âŒ LLM_BASE_URL is NOT set"
            MISSING="$MISSING LLM_BASE_URL"
          else
            echo "âœ… LLM_BASE_URL: ${LLM_BASE_URL:0:40}..."
          fi

          if [ -z "$RAGFLOW_BASE_URL" ]; then
            echo "âŒ RAGFLOW_BASE_URL is NOT set"
            MISSING="$MISSING RAGFLOW_BASE_URL"
          else
            echo "âœ… RAGFLOW_BASE_URL: ${RAGFLOW_BASE_URL:0:40}..."
          fi

          # ì„ íƒì  ë³€ìˆ˜ ìƒíƒœ ì¶œë ¥
          echo "----------------------------------------------"
          echo "Optional variables:"
          [ -n "$MILVUS_HOST" ] && echo "  MILVUS_HOST: $MILVUS_HOST" || echo "  MILVUS_HOST: (not set)"
          [ -n "$MILVUS_PORT" ] && echo "  MILVUS_PORT: $MILVUS_PORT" || echo "  MILVUS_PORT: (not set)"
          [ -n "$BACKEND_BASE_URL" ] && echo "  BACKEND_BASE_URL: ${BACKEND_BASE_URL:0:40}..." || echo "  BACKEND_BASE_URL: (not set)"
          echo "=============================================="

          if [ -n "$MISSING" ]; then
            echo ""
            echo "ðŸš¨ FATAL: Missing required env vars:$MISSING"
            echo "Please add these to GitHub Secrets:"
            echo "  Repository Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi

          echo "âœ… All required environment variables are set!"

      # =========================================================================
      # Integration í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      # =========================================================================
      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          pytest tests/integration/ -v --tb=short \
            --junit-xml=integration-results.xml \
            2>&1 | tee integration-test-output.txt

          # ê²°ê³¼ ìš”ì•½
          echo ""
          echo "=============================================="
          echo "Test Results Summary"
          echo "=============================================="
          grep -E "(passed|failed|skipped|error)" integration-test-output.txt | tail -5 || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            integration-results.xml
            integration-test-output.txt
          retention-days: 7

      # =========================================================================
      # ì„œë¹„ìŠ¤ ì •ë¦¬ (docker compose down)
      # =========================================================================
      - name: Stop services
        if: ${{ always() && inputs.skip_service_setup != 'true' }}
        run: |
          if [ -f "docker-compose.ci.yml" ]; then
            docker compose -f docker-compose.ci.yml down -v || true
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo ""
          echo "ðŸš¨ Integration tests FAILED!"
          echo ""
          echo "Possible causes:"
          echo "  1. GitHub Secrets not configured (LLM_BASE_URL, RAGFLOW_BASE_URL)"
          echo "  2. Services not reachable from runner"
          echo "  3. Test assertions failed"
          echo ""
          echo "Check the logs above for details."
          # TODO: Slack/Discord webhook notification
