# AI 개발팀 회의록 - 2025년 12월 23일

> **회의 기간**: 2025-12-20 ~ 2025-12-23
> **작성일**: 2025-12-30
> **작성자**: Claude Code

---

## 1. 회의 개요

12월 20일부터 23일까지의 개발 작업 내용을 종합 정리합니다. 이 기간 동안 대규모 리팩토링(Phase 42), API 정리, 문서화 작업이 집중적으로 진행되었습니다.

---

## 2. 날짜별 작업 내역

### 2.1 12월 20일 (금)

#### 버그 수정 및 API 정리
| 작업 | 상세 내용 | 커밋 |
|------|----------|------|
| import 에러 수정 | `ws_render` → `ws_render_progress` import 경로 수정 (7개 파일) | `b447aa9` |
| 메서드명 수정 | `_get_auth_headers` → `_get_bearer_headers` | `b447aa9` |
| API prefix 수정 | render_jobs.py prefix `/api` → `/api/v2` 복원 | `76db602` |

**테스트 결과**: 989 passed, 24 failed (+1 개선)

---

### 2.2 12월 21일 (토)

- 주말로 인해 별도 커밋 없음

---

### 2.3 12월 22일 (일)

#### Phase 42: 대규모 리팩토링

12월 22일은 프로젝트의 핵심 아키텍처 개선 작업이 집중적으로 이루어진 날입니다.

##### 2.3.1 ChatService 분할 리팩토링

**Step 1: 클라이언트 싱글톤화**
| Step | 작업 내용 | 파일 |
|------|----------|------|
| 1.1 | LLMClient 싱글톤화 | `app/clients/llm_client.py` |
| 1.2 | RagflowClient 싱글톤화 | `app/clients/ragflow_client.py` |
| 1.3 | PiiService 싱글톤화 | `app/services/pii_service.py` |
| 1.4 | conftest.py 싱글톤 정리 fixture 추가 | `tests/conftest.py` |
| 1.4-B | PiiService 공용 HTTP 클라이언트 사용 | `app/services/pii_service.py` |
| 1.5 | ChatService에서 싱글톤 사용 | `app/services/chat_service.py` |

**Step 2: ChatService 서브패키지 분할**
| Step | 추출 클래스 | 파일 |
|------|------------|------|
| 2.1 | 패키지 구조 생성 | `app/services/chat/__init__.py` |
| 2.2 | RouteMapper 추출 | `app/services/chat/route_mapper.py` |
| 2.3 | ResponseFactory 추출 | `app/services/chat/response_factory.py` |
| 2.4 | RagHandler 추출 | `app/services/chat/rag_handler.py` |
| 2.5 | BackendHandler 추출 | `app/services/chat/backend_handler.py` |
| 2.6 | MessageBuilder 추출 | `app/services/chat/message_builder.py` |

##### 2.3.2 Direct Milvus 인덱싱 제거 (A안 확정)

팀 합의에 따라 Direct Milvus 인덱싱 방식 대신 SourceSet Orchestrator → RAGFlow 경로만 사용하기로 결정했습니다.

**삭제된 파일:**
- `app/services/kb_index_service.py`
- `tests/test_phase28_kb_indexing.py`
- `tests/test_phase29_kb_e2e.py`
- `tests/test_phase30_internal_rag.py`
- `tests/test_internal_rag.py`

**Deprecated 처리:**
- `/internal/rag/*` 엔드포인트 → HTTP 410 Gone 반환
- MilvusSearchClient → 읽기 전용으로 변환 (upsert_chunks, delete_chunks 제거)

##### 2.3.3 테스트 구조 개선

**폴더 분리:**
```
tests/
├── unit/           # 외부 서비스 없이 실행 (env 비움)
├── integration/    # 실제 LLM/RAGFlow/Milvus 필요
└── conftest.py     # 공통 fixture만 유지
```

**CI 워크플로우 분리:**
- `ci-unit.yml`: PR마다 실행, 빠른 피드백
- `ci-integration.yml`: main/nightly, 실제 서비스 필요

##### 2.3.4 기타 개선

| 작업 | 상세 내용 |
|------|----------|
| SourceSet 오케스트레이터 서비스 구현 | 멀티 문서 소스셋 처리 및 스크립트 자동 생성 |
| SourceSet Pydantic 모델 추가 | SourceSetStatus, SourceSetStartRequest/Response 등 |
| BackendClient 메서드 추가 | get_source_set_documents(), notify_source_set_complete() 등 |
| 렌더 잡 상태값 정규화 | PENDING→QUEUED, RUNNING→PROCESSING, SUCCEEDED→COMPLETED |
| GitHub Actions 배포 워크플로우 추가 | self-hosted runner 기반 자동 배포 |

---

### 2.4 12월 23일 (월)

#### 2.4.1 API 및 문서화 작업

| 작업 | 상세 내용 | 커밋 |
|------|----------|------|
| FAQ 파이프라인 분석 문서 추가 | 10단계 처리 플로우 상세 설명 | `fdc348b` |
| 영상 제작 파이프라인 아키텍처 문서 추가 | - | `34d5d17` |
| 채팅 파이프라인 아키텍처 문서 추가 | - | `40ba552` |
| 영상 API 변경사항 안내 문서 추가 | - | `375c025` |
| Phase 42 반영 API 문서 정리 | 구버전 v2.1, v2.2 삭제, v2.3 추가 | `2b34b57` |

#### 2.4.2 SourceSet 오케스트레이션 강화

| 작업 | 상세 내용 |
|------|----------|
| SourceSet 오케스트레이션 테스트 추가 | RagflowClient Step 3 메서드 테스트 16개, SourceSetOrchestrator 테스트 19개 |
| RAGFlow polling 설정 추가 | config.py에 설정 추가 |
| 문서 파싱 상태 polling 및 청크 조회 기능 추가 | ragflow_client.py |

#### 2.4.3 보안 및 인증 강화

| 작업 | 상세 내용 | 커밋 |
|------|----------|------|
| render-jobs internal API에 X-Internal-Token 인증 추가 | verify_internal_token 의존성 함수 추가 | `ef02b28` |
| FE용 scripts API 제거 | FE는 백엔드 경유 필수 정책 반영 | `40ba093` |
| SourceSet 콜백 스펙 정렬 | scene_id/chapter_id 제거 (백엔드 JPA 자동생성) | `2adcb4f` |

#### 2.4.4 테스트 격리 개선

```python
# conftest.py: 각 테스트 전후 환경변수 정리로 격리 강화
# test_personalization.py: skipif → pytest.skip()으로 변경
```

---

## 3. 핵심 의사결정 사항

### 3.1 A안 확정: RAGFlow 경유 인덱싱

| 항목 | 결정 내용 |
|------|----------|
| 인덱싱 방식 | Direct Milvus 인덱싱 제거 |
| 경로 | SourceSet Orchestrator → RAGFlow 경로만 사용 |
| MilvusSearchClient | 읽기 전용 검색만 수행 |
| /internal/rag/* | Deprecated (HTTP 410 Gone) |

### 3.2 FE 접근 정책

| 항목 | 결정 내용 |
|------|----------|
| FE → AI 직접 호출 | 금지 |
| 정책 | FE는 반드시 백엔드를 경유하여 AI 서비스 호출 |
| 조치 | `/api/scripts/*` 엔드포인트 삭제 |

---

## 4. 테스트 현황

| 구분 | 테스트 수 | 상태 |
|------|----------|------|
| Unit 테스트 | 약 990개 | 정상 |
| Integration E2E Smoke 테스트 | 신규 추가 | 정상 |
| Phase 42 리팩토링 관련 테스트 | 전체 통과 | 정상 |

---

## 5. 파일 변경 요약

### 5.1 신규 생성 파일

| 파일 경로 | 설명 |
|----------|------|
| `app/services/chat/__init__.py` | ChatService 서브패키지 |
| `app/services/chat/route_mapper.py` | 라우팅 매핑 로직 |
| `app/services/chat/response_factory.py` | 응답 생성 팩토리 |
| `app/services/chat/rag_handler.py` | RAG 검색 핸들러 |
| `app/services/chat/backend_handler.py` | 백엔드 데이터 조회 핸들러 |
| `app/services/chat/message_builder.py` | LLM 메시지 빌더 |
| `app/services/source_set_orchestrator.py` | SourceSet 오케스트레이터 |
| `app/api/v1/source_sets.py` | SourceSet API 라우터 |
| `docs/FAQ_PIPELINE_ANALYSIS.md` | FAQ 파이프라인 분석 문서 |
| `docs/VIDEO_PIPELINE_ARCHITECTURE.md` | 영상 파이프라인 아키텍처 |
| `docs/CHAT_PIPELINE_ARCHITECTURE.md` | 채팅 파이프라인 아키텍처 |

### 5.2 삭제된 파일

| 파일 경로 | 이유 |
|----------|------|
| `app/services/kb_index_service.py` | A안 확정으로 불필요 |
| `app/api/v1/scripts.py` | FE 직접 호출 금지 정책 |
| `tests/test_phase28_kb_indexing.py` | A안 확정 |
| `tests/test_phase29_kb_e2e.py` | A안 확정 |
| `tests/test_phase30_internal_rag.py` | A안 확정 |

---

## 6. 다음 작업 예정

| 우선순위 | 작업 항목 | 담당 |
|---------|----------|------|
| 높음 | S3 presigned URL 방식 변경 | AI팀 |
| 높음 | LLM/임베딩 서버 URL 분리 | AI팀 |
| 중간 | Milvus 직접 검색 통합 (Option 3) | AI팀 |
| 중간 | 성능 개선 작업 (Phase 43~46) | AI팀 |

---

## 7. 참고 문서

- [Phase 42 개발 리포트](./DEVELOPMENT_REPORT_PHASE42.md)
- [API 명세서 v2.3](./ctrlf_api_spec_fastapi_orchestrator_v2_3_db_aligned.md)
- [FAQ 파이프라인 분석](./FAQ_PIPELINE_ANALYSIS.md)
- [채팅 파이프라인 아키텍처](./CHAT_PIPELINE_ARCHITECTURE.md)

---

**회의록 종료**
