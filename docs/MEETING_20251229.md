# AI 개발팀 회의록 - 2025년 12월 29일

> **회의 기간**: 2025-12-25 ~ 2025-12-29
> **작성일**: 2025-12-30
> **작성자**: Claude Code

---

## 1. 회의 개요

12월 25일부터 29일까지의 개발 작업 내용을 종합 정리합니다. 이 기간 동안 **Option 3 Milvus 통합**, **성능 개선 Phase 43~50**, **FAQ 파트 인수인계 문서 작성** 등 핵심 작업이 진행되었습니다.

---

## 2. 날짜별 작업 내역

### 2.1 12월 25일 (수)

#### 2.1.1 Option 3: Milvus 직접 검색 통합

**핵심 결정**: Milvus 직접 검색을 FAQ/Chat/Script 서비스에 통합하고, RAGFlow를 Fallback으로 사용

##### A. Chat 서비스 Milvus 전환

| 항목 | 구현 내용 |
|------|----------|
| RagHandler | Milvus → RAGFlow fallback 로직 추가 |
| 환경변수 | `CHAT_RETRIEVER_BACKEND` 서비스별 라우팅 |
| 응답 필드 | `retriever_used` 추가 (MILVUS, RAGFLOW, RAGFLOW_FALLBACK) |
| 컨텍스트 제한 | `CHAT_CONTEXT_MAX_CHARS`, `CHAT_CONTEXT_MAX_SOURCES` |

##### B. Script 생성 Milvus 전환

| 항목 | 구현 내용 |
|------|----------|
| SourceSetOrchestrator | Milvus 라우팅 추가 |
| 문서 처리 | `_process_document_with_routing`: Milvus/RAGFlow 분기 |
| 파일명 추출 | `_extract_milvus_doc_id`: source_url에서 파일명 추출 |
| 청크 조회 | `_fetch_document_chunks_milvus`: Milvus 청크 직접 조회 |

##### C. FAQ 서비스 Milvus 연동

| 항목 | 구현 내용 |
|------|----------|
| MilvusSearchClient | `get_document_chunks`, `get_full_document_text` 메서드 추가 |
| FaqDraftService | Milvus 직접 검색 기능 통합 |
| Fallback | `MILVUS_ENABLED=true` + Milvus 실패 시 → RAGFlow 자동 폴백 |
| answer_source | "MILVUS" 추가 |

##### D. 임베딩 계약 검증 (Fail-fast)

```python
# 서버 기동 시 dim 불일치 조기 감지
def verify_embedding_contract():
    """
    런타임 로그 출력:
    [MILVUS_RUNTIME] host=localhost:19540 | collection=ragflow_chunks_sroberta
                    | collection_dim=768 | embedding_model=jhgan/ko-sroberta-multitask
                    | embedding_output_dim=768
    """
```

##### E. 환경변수 추가

```bash
# 서비스별 검색 백엔드
FAQ_RETRIEVER_BACKEND=milvus
CHAT_RETRIEVER_BACKEND=milvus
SCRIPT_RETRIEVER_BACKEND=milvus

# 채팅 컨텍스트 제한
CHAT_CONTEXT_MAX_CHARS=8000
CHAT_CONTEXT_MAX_SOURCES=5
```

##### F. 관련 커밋

| 커밋 | 내용 |
|------|------|
| `82a85a7` | Option 3 Chat/Script Milvus 통합 |
| `af1f331` | FAQ 서비스에 Milvus 직접 검색 연동 (Option 3/B안) |
| `1a5d32c` | 임베딩 검증, pagination, 보안, async 최적화 |
| `fafdea2` | 런타임 로그에 Milvus 연결 정보 출력 추가 |

---

#### 2.1.2 성능 개선 Phase 45/46: 소프트 가드레일

##### Phase 45
| 항목 | 구현 내용 |
|------|----------|
| 소프트 가드레일 | POLICY_QA/EDUCATION_QA + sources=0 → 경고 prefix |
| 한국어 강제 | `KOREAN_ONLY_INSTRUCTION` 시스템 프롬프트 추가 |
| Similarity 로깅 | 검색 품질 진단용 분포 로깅 추가 |

##### Phase 46
| 항목 | 구현 내용 |
|------|----------|
| DOMAIN_CONTACT_INFO | 키 정렬 (EDUCATION 별칭 추가) |
| 확정 표현 금지 | 금지/허용 표현 상세 지침 |
| 지표 분리 정의 | Availability/RAG/정답 지표 분리 |

**테스트 결과**: 96 tests passed (guard, e2e, rag_gap, router 관련)

---

### 2.2 12월 26일 (목)

#### 2.2.1 문서 정리 및 보안 강화

| 작업 | 상세 내용 | 커밋 |
|------|----------|------|
| 문서 통합 | MILVUS_INTEGRATION_GUIDE.md 삭제 → BACKEND_INTEGRATION_GUIDE.md로 통합 | `2f89b02` |
| 보안 수정 | 문서에서 내부 IP 주소 제거 | `2b9d0b5` |
| 백엔드 연동 가이드 | 업데이트 | `2a68703` |
| dataset_id 변경 | 더미 dataset_id를 실제 Milvus 값으로 변경 | `c29b659` |
| API 테스트 | Quiz/SourceSet API 테스트 추가 | `5248d4c` |
| .gitignore | dummy_data, nul 추가 | `76a322e` |

---

### 2.3 12월 27일 (금)

- 커밋 기록 없음

---

### 2.4 12월 28일 (토)

#### 2.4.1 Phase 47: GPT 피드백 반영

GPT 리뷰 피드백을 반영하여 다음 항목을 수정했습니다:

| 지적 사항 | 해결 방법 |
|----------|----------|
| `'~입니다'` 금지 표현에 포함 | 한국어 기본 서술 종결어미므로 제거 |
| `soft_guardrail_instruction`이 RAG 경로에만 적용 | 모든 경로(MIXED, BACKEND_API)에 적용 |
| DOMAIN_CONTACT_INFO 혼재 | 시스템 도메인/교육 주제 카테고리 분리, 정규화 함수 추가 |

**수정 파일**:
- `app/services/answer_guard_service.py`
- `app/services/chat_service.py`
- `app/services/chat/message_builder.py`

#### 2.4.2 Phase 48: Low-relevance Gate 구현

저품질 검색 결과를 자동으로 강등시키는 2단계 Gate 시스템 구현:

```
RAG 검색 결과
    │
    ▼
┌─────────────────┐
│   Score Gate    │  max_score < 0.60 → sources=[]
└────────┬────────┘
         │ 통과
         ▼
┌─────────────────┐
│  Anchor Gate    │  핵심 키워드가 sources에 없음 → sources=[]
└────────┬────────┘
         │ 통과
         ▼
     최종 결과
```

**구현 함수**:
- `get_anchor_stopwords()`: 불용어 세트 로드
- `extract_anchor_keywords(query)`: 쿼리에서 핵심 키워드 추출
- `check_anchor_keywords_in_sources()`: 키워드가 sources에 있는지 확인
- `apply_low_relevance_gate()`: 두 게이트 적용

**dataset_id 필터**:
```python
DOMAIN_DATASET_MAPPING = {
    "POLICY": "사내규정",
    "EDUCATION": "정보보안교육",
}
```

**테스트 결과**:
```
=== Test 4: Low-relevance Gate ===
[PASS] High score + keyword match -> PASSED: 2 sources
[PASS] Low score -> DEMOTED: reason=max_score_below_threshold
[PASS] Keyword mismatch -> DEMOTED: reason=no_anchor_term_match
[PASS] Empty sources -> stays empty: 0
```

#### 2.4.3 문서 작업

| 작업 | 상세 내용 | 커밋 |
|------|----------|------|
| 테스트 가이드 추가 | 연결 테스트 가이드 및 API 엔드포인트 수정 | `70fa6d8` |
| 로컬 테스트 환경 | 로컬 테스트 환경 구축 가이드 추가 | `1c6f67f` |
| 백엔드 마이크로서비스 | 실행 및 스크립트/영상 테스트 가이드 추가 | `a8413cb` |
| 테스트 시나리오 | 시나리오별 최소 구성 섹션 추가 | `1d0f4c1` |
| Phase 43-47 종합 보고서 | 채팅 품질 개선 종합 보고서 추가 | `913d78c` |
| README | 환경 설정 섹션 마크다운 수정, 유니코드 인코딩 복구 | `f0f03e8`, `ce87def` |

---

### 2.5 12월 29일 (일)

#### 2.5.1 Phase 49: 도메인 라우팅 개선

RuleRouter의 도메인 분류 정확도를 향상시켰습니다.

##### 문제점
| 쿼리 | 기대 결과 | 기존 결과 |
|------|----------|----------|
| "연차 규정 알려줘" | POLICY | HR (UNKNOWN) |
| "근태 관련 규정" | POLICY | HR |
| "정보보호교육 내용" | EDUCATION | POLICY |

##### 해결책
1. **경계 B 체크 개선**: "규정", "정책" 등이 있으면 명확히 정책으로 판단
2. **복합 조건 우선 체크**: "교육" 포함 시 EDU 우선, "규정" 포함 시 POLICY 우선
3. **교육 키워드 확장**: 성희롱예방교육, 장애인식개선교육 등 추가
4. **ASCII-safe 로깅**: Git Bash 한글 깨짐 방지

##### Config 분리
```python
# EDUCATION dataset_id allowlist 설정 (환경변수로 분리)
RAG_EDUCATION_DATASET_IDS: str = (
    "정보보안교육,성희롱예방교육,장애인식개선교육,직장내괴롭힘예방교육,개인정보보호교육"
)

# 요약 인텐트 피처 플래그 (기본 OFF)
SUMMARY_INTENT_ENABLED: bool = False
```

#### 2.5.2 Phase 50: LowRelevanceGate 개선

Phase 48의 Hard Gate를 Soft Gate로 전환했습니다.

##### 문제점
| 쿼리 | 증상 | 원인 |
|------|------|------|
| "연차휴가 규정 알려줘" | 소스 0개 | "알려줘"가 anchor_keywords에 포함 |
| "보안 관련 문서 요약해줘" | 소스 0개 | "요약해줘"가 anchor_keywords에 포함 |

##### 해결책

1. **ACTION_TOKENS 필터링**:
```python
ACTION_TOKENS = frozenset([
    "요약해줘", "요약해주세요", "알려줘", "알려주세요",
    "설명해줘", "보여줘", "찾아줘", "해줘", "해주세요", ...
])
```

2. **매칭 대상 확장**: title+snippet → article_label+article_path 추가

3. **Soft Gate 안전장치**:
```python
ANCHOR_GATE_MIN_KEEP = 1  # 최소 1개 소스 보장
```

4. **임계값 하향**: 0.60 → 0.55

5. **ai_log URL 이중 슬래시 수정**:
```python
base_url = settings.backend_base_url.rstrip("/")
self._backend_log_endpoint = f"{base_url}/api/ai-logs"
```

##### 테스트 결과
| 쿼리 | Before (Phase 48) | After (Phase 50) |
|------|-------------------|------------------|
| "연차휴가 규정 알려줘" | 소스 0개 | 소스 1개+, **통과** |
| "보안 관련 문서 요약해줘" | 소스 0개 | 소스 1개+, **통과** |

#### 2.5.3 FAQ 파트 인수인계

FAQ 파트에 대한 상세 인수인계 보고서를 작성했습니다.

**문서 내용**:
- 파일 구조 및 역할
- API 엔드포인트 상세 (단건/배치)
- 데이터 모델 (Request/Response)
- 서비스 로직 상세 (10단계 플로우)
- 의존성 서비스 (PiiService, RagflowSearchClient, LLMClient)
- 환경변수 설정
- 에러 코드 및 처리
- 테스트 파일
- 백엔드 연동 가이드

**커밋**: `1d561bd`

#### 2.5.4 기타 작업

| 작업 | 상세 내용 | 커밋 |
|------|----------|------|
| POLICY 문서 ingest API 추가 | - | `9659433` |
| RAGFlow fallback 제거 | Milvus 전용 검색으로 변경 | `906b80e` |
| pymilvus 의존성 추가 | - | `12f6a7c` |
| PR #17 머지 후 테스트 수정 | - | `03ba2d7` |
| FAQ 테스트 시그니처 업데이트 | - | `20c5947` |
| domain 라우팅 정책 강화 | fallback 금지 | `001d7a8` |

---

## 3. 핵심 의사결정 사항

### 3.1 Option 3 Milvus 통합 전략

| 서비스 | 검색 방식 | Fallback |
|--------|----------|----------|
| FAQ | Milvus 우선 | RAGFlow |
| Chat | Milvus 우선 | RAGFlow |
| Script | Milvus 우선 | RAGFlow |

### 3.2 Low-relevance Gate 정책

| 항목 | Phase 48 | Phase 50 |
|------|----------|----------|
| Gate 방식 | Hard Gate | Soft Gate |
| 최소 소스 | 0개 (전량 필터) | 1개 보장 |
| Score 임계값 | 0.60 | 0.55 |

### 3.3 도메인 라우팅 우선순위

```
1. "교육" 포함 → EDU_CONTENT_KEYWORDS 매칭 → EDUCATION_QA
2. "규정/정책" 포함 → POLICY_KEYWORDS 매칭 → POLICY_QA
3. 기타 → 기존 순서대로 분류
```

---

## 4. Phase 흐름 정리

```
Phase 43:    "하" 키워드 버그 수정
Phase 44:    가드레일 완화
Phase 45:    소프트 가드레일 & 언어 강제
Phase 46:    소프트 가드레일 강화, 지표 분리 정의
Phase 47:    GPT 피드백 반영 (코드 안정성)
Phase 48:    Low-relevance Gate + dataset 필터
Phase 49:    도메인 라우팅 정확도 + 운영 유연성
Phase 50:    LowRelevanceGate 개선 (Soft Gate)
```

---

## 5. 테스트 현황

| 테스트 카테고리 | 테스트 수 | 상태 |
|----------------|----------|------|
| Phase 50 Low-relevance Gate | 24개 | 전체 통과 |
| Phase 49 RuleRouter | 5개 | 전체 통과 |
| Phase 48 Changes | 5개 | 전체 통과 |
| FAQ 서비스 | 다수 | 전체 통과 |
| Option 3 Chat Integration | 5개 | 전체 통과 |
| Option 3 Script Integration | 6개 | 전체 통과 |

**총 테스트**: 62+ tests passed

---

## 6. 환경변수 추가 요약

| 환경변수 | 기본값 | 설명 |
|----------|--------|------|
| `FAQ_RETRIEVER_BACKEND` | milvus | FAQ 서비스 검색 백엔드 |
| `CHAT_RETRIEVER_BACKEND` | milvus | 채팅 서비스 검색 백엔드 |
| `SCRIPT_RETRIEVER_BACKEND` | milvus | 스크립트 생성 검색 백엔드 |
| `CHAT_CONTEXT_MAX_CHARS` | 8000 | 채팅 컨텍스트 최대 문자 수 |
| `CHAT_CONTEXT_MAX_SOURCES` | 5 | 채팅 컨텍스트 최대 소스 수 |
| `RAG_MIN_MAX_SCORE` | 0.55 | Score Gate 임계값 |
| `RAG_ANCHOR_STOPWORDS` | (불용어 목록) | 앵커 키워드 추출 시 제외할 단어 |
| `RAG_DATASET_FILTER_ENABLED` | true | dataset_id 필터 활성화 |
| `RAG_EDUCATION_DATASET_IDS` | (교육 ID 목록) | EDUCATION 도메인 dataset_id allowlist |
| `SUMMARY_INTENT_ENABLED` | false | 요약 인텐트 분리 (피처 플래그) |

---

## 7. 파일 변경 요약

### 7.1 신규 생성 파일

| 파일 | 설명 |
|------|------|
| `docs/FAQ_HANDOVER_REPORT.md` | FAQ 파트 인수인계 보고서 |
| `docs/PERFORMANCE_IMPROVEMENT_REPORT_PHASE49.md` | Phase 49 성능 개선 보고서 |
| `docs/PERFORMANCE_IMPROVEMENT_REPORT_v7.md` | Phase 50 성능 개선 보고서 |
| `docs/RETRIEVAL_FALLBACK_POLICY.md` | 검색 Fallback 정책 문서 v2.0.0 |
| `scripts/test_phase48_changes.py` | Phase 48 테스트 스크립트 |
| `scripts/test_phase49_changes.py` | Phase 49 테스트 스크립트 |
| `tests/unit/test_phase50_low_relevance_gate.py` | Phase 50 단위 테스트 |

### 7.2 주요 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `app/core/config.py` | Phase 48/49/50 설정 추가 |
| `app/services/chat/rag_handler.py` | Low-relevance Gate, Soft Gate, ACTION_TOKENS |
| `app/services/rule_router.py` | 복합 조건 체크, 교육 키워드 확장 |
| `app/clients/milvus_client.py` | dataset_id 필터, EDUCATION 동적 로드 |
| `app/services/answer_guard_service.py` | 도메인 정규화, topic 파라미터 |
| `app/services/faq_service.py` | Milvus 직접 검색 통합 |
| `app/services/source_set_orchestrator.py` | Milvus 라우팅 추가 |

---

## 8. 참고 문서

- [Phase 49 성능 개선 보고서](./PERFORMANCE_IMPROVEMENT_REPORT_PHASE49.md)
- [Phase 50 성능 개선 보고서](./PERFORMANCE_IMPROVEMENT_REPORT_v7.md)
- [FAQ 인수인계 보고서](./FAQ_HANDOVER_REPORT.md)
- [Retrieval Fallback 정책](./RETRIEVAL_FALLBACK_POLICY.md)
- [성능 개선 보고서 v5](./PERFORMANCE_IMPROVEMENT_REPORT_v5.md)

---

## 9. 다음 작업 예정

| 우선순위 | 작업 항목 | 상태 |
|---------|----------|------|
| 높음 | Qwen2.5 중국어 출력 문제 해결 | 12/30 진행 예정 |
| 높음 | 스트리밍 채팅 품질 개선 | 12/30 진행 예정 |
| 중간 | 형태소 분석기 도입 검토 | 향후 검토 |
| 중간 | 요약 인텐트 파이프라인 구현 | 피처 플래그 활성화 후 |

---

**회의록 종료**
