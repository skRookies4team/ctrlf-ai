# CTRL-F AI ì±„íŒ… íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜

> **ë¬¸ì„œ ë²„ì „**: 1.2
> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-12-31
> **ì‘ì„± ê¸°ì¤€**: ì‹¤ì œ ì½”ë“œ ë¶„ì„ (`router_types.py`, `personalization.py` í¬í•¨)

---

## ëª©ì°¨

1. [ê°œìš”](#1-ê°œìš”)
2. [ì „ì²´ ì•„í‚¤í…ì²˜](#2-ì „ì²´-ì•„í‚¤í…ì²˜)
3. [ChatService 16ë‹¨ê³„ íŒŒì´í”„ë¼ì¸](#3-chatservice-16ë‹¨ê³„-íŒŒì´í”„ë¼ì¸)
4. [Route íƒ€ì…ë³„ ë°ì´í„° íë¦„](#4-route-íƒ€ì…ë³„-ë°ì´í„°-íë¦„)
5. [ì—­í• Ã—ë„ë©”ì¸â†’Route ë§¤í•‘](#5-ì—­í• ë„ë©”ì¸route-ë§¤í•‘)
6. [í•µì‹¬ íŒŒì¼ êµ¬ì¡°](#6-í•µì‹¬-íŒŒì¼-êµ¬ì¡°)
7. [ìŠ¤íŠ¸ë¦¬ë° íŒŒì´í”„ë¼ì¸](#7-ìŠ¤íŠ¸ë¦¬ë°-íŒŒì´í”„ë¼ì¸)
8. [ë‹¨ê³„ë³„ ë°ì´í„° ë³€í™˜ ìƒì„¸](#8-ë‹¨ê³„ë³„-ë°ì´í„°-ë³€í™˜-ìƒì„¸)
9. [ë°ì´í„° í¬ê¸° ë³€í™” ìš”ì•½](#9-ë°ì´í„°-í¬ê¸°-ë³€í™”-ìš”ì•½)
10. [ì¸í…íŠ¸ ì²´ê³„ (Tier-0 + Sub-Intent)](#10-ì¸í…íŠ¸-ì²´ê³„-tier-0--sub-intent)

---

## 1. ê°œìš”

CTRL-F AI ì±„íŒ… ì‹œìŠ¤í…œì€ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë°›ì•„ RAG(Retrieval-Augmented Generation) ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” íŒŒì´í”„ë¼ì¸ì…ë‹ˆë‹¤.

### ì£¼ìš” íŠ¹ì§•

- **16ë‹¨ê³„ íŒŒì´í”„ë¼ì¸**: PII ë§ˆìŠ¤í‚¹ â†’ Intent ë¶„ë¥˜ â†’ RAG ê²€ìƒ‰ â†’ LLM ìƒì„± â†’ ê²€ì¦
- **ì—­í•  ê¸°ë°˜ ë¼ìš°íŒ…**: EMPLOYEE, ADMIN, INCIDENT_MANAGERë³„ ë‹¤ë¥¸ ì²˜ë¦¬ ê²½ë¡œ
- **3ë‹¨ê³„ PII ë§ˆìŠ¤í‚¹**: INPUT, OUTPUT, LOG ë‹¨ê³„ë³„ ê°œì¸ì •ë³´ ë³´í˜¸
- **Phase 39 ê°€ë“œë ˆì¼**: ë¯¼ì› Fast Path, Answerability Gate, Citation ê²€ì¦

### API ì—”ë“œí¬ì¸íŠ¸

| ì—”ë“œí¬ì¸íŠ¸ | ë©”ì„œë“œ | ì„¤ëª… |
|-----------|--------|------|
| `/ai/chat/messages` | POST | ë™ê¸° ì±„íŒ… ì‘ë‹µ |
| `/ai/chat/stream` | POST | ìŠ¤íŠ¸ë¦¬ë° ì±„íŒ… ì‘ë‹µ (NDJSON) |

---

## 2. ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT REQUEST                                  â”‚
â”‚                    POST /ai/chat/messages (ë™ê¸°)                             â”‚
â”‚                    POST /ai/chat/stream   (ìŠ¤íŠ¸ë¦¬ë°)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         app/api/v1/chat.py                                  â”‚
â”‚                         app/api/v1/chat_stream.py                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ChatRequest                                                         â”‚    â”‚
â”‚  â”‚  â”œâ”€ session_id, user_id, user_role                                  â”‚    â”‚
â”‚  â”‚  â”œâ”€ department, domain, channel                                      â”‚    â”‚
â”‚  â”‚  â””â”€ messages: List[ChatMessage]                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    app/services/chat_service.py                             â”‚
â”‚                         ChatService.handle_chat()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ChatService 16ë‹¨ê³„ íŒŒì´í”„ë¼ì¸

### ì „ì²´ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: ì¿¼ë¦¬ ì¶”ì¶œ                                                           â”‚
â”‚  user_query = req.messages[-1].content                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: PII ë§ˆìŠ¤í‚¹ (INPUT)                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  PiiService.detect_and_mask()      â”‚                                      â”‚
â”‚  â”‚  Stage: MaskingStage.INPUT         â”‚                                      â”‚
â”‚  â”‚  Output: masked_query, has_pii     â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: ë¯¼ì› Fast Path (Phase 39)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  AnswerGuardService                â”‚â”€â”€â”€â”€ ë¯¼ì› ê°ì§€ â”€â”€â”€â–¶ [ì¡°ê¸° ì¢…ë£Œ]       â”‚
â”‚  â”‚  .check_complaint_fast_path()      â”‚                    Route: LLM_ONLY   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Router Orchestrator (Phase 22)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  RouterOrchestrator.route()        â”‚                                      â”‚
â”‚  â”‚  â”œâ”€ clarify í•„ìš” ì—¬ë¶€              â”‚                                      â”‚
â”‚  â”‚  â”œâ”€ confirmation ì²˜ë¦¬              â”‚                                      â”‚
â”‚  â”‚  â”œâ”€ SYSTEM_HELP ê°ì§€               â”‚                                      â”‚
â”‚  â”‚  â””â”€ UNKNOWN ë¼ìš°íŠ¸ ì²˜ë¦¬            â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Intent ë¶„ë¥˜                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  IntentService.classify()                                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ IntentType       â”‚ DomainHint       â”‚ RouteType                   â”‚ â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  â”‚
â”‚  â”‚  â”‚ POLICY_QA        â”‚ POLICY           â”‚ RAG_INTERNAL                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ INCIDENT_REPORT  â”‚ INCIDENT         â”‚ BACKEND_API                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ INCIDENT_QA      â”‚ INCIDENT         â”‚ RAG_INTERNAL/MIXED          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ EDU_STATUS       â”‚ EDUCATION        â”‚ BACKEND_API                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ EDUCATION_QA     â”‚ EDUCATION        â”‚ RAG_INTERNAL                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ GENERAL_CHAT     â”‚ GENERAL          â”‚ LLM_ONLY                    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: Routeë³„ ë°ì´í„° Fetching                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   RAG_INTERNAL â”€â”€â”€â”€â”€â–¶ RagHandler.perform_search_with_fallback()       â”‚  â”‚
â”‚  â”‚                       â””â”€ RagflowClient â†’ RAG ë¬¸ì„œ ê²€ìƒ‰                 â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   MIXED_BACKEND_RAG â”€â–¶ â”¬â”€ RagHandler (ë³‘ë ¬)                           â”‚  â”‚
â”‚  â”‚                        â””â”€ BackendHandler.fetch_for_mixed() (ë³‘ë ¬)     â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   BACKEND_API â”€â”€â”€â”€â”€â”€â”€â–¶ BackendHandler.fetch_for_api()                 â”‚  â”‚
â”‚  â”‚                        â””â”€ BackendDataClient API í˜¸ì¶œ                   â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   LLM_ONLY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (ë°ì´í„° Fetching ì—†ìŒ)                         â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: Answerability Gate (Phase 39)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  AnswerGuardService                â”‚                                      â”‚
â”‚  â”‚  .check_answerability()            â”‚                                      â”‚
â”‚  â”‚  â”œâ”€ POLICY_QA + RAG ì—†ìŒ â†’ ì°¨ë‹¨    â”‚                                      â”‚
â”‚  â”‚  â””â”€ EDUCATION_QA + RAG ì—†ìŒ â†’ ì°¨ë‹¨ â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: LLM ë©”ì‹œì§€ ë¹Œë“œ                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MessageBuilder (app/services/chat/message_builder.py)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ build_rag_messages()          â†’ RAG_INTERNAL ìš©                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ build_mixed_messages()        â†’ MIXED_BACKEND_RAG ìš©              â”‚  â”‚
â”‚  â”‚  â””â”€ build_backend_api_messages()  â†’ BACKEND_API ìš©                    â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  System Prompts:                                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ SYSTEM_PROMPT_WITH_RAG                                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ SYSTEM_PROMPT_NO_RAG                                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ SYSTEM_PROMPT_MIXED_BACKEND_RAG                                   â”‚  â”‚
â”‚  â”‚  â””â”€ SYSTEM_PROMPT_BACKEND_API                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 9: LLM ì‘ë‹µ ìƒì„±                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  LLMClient.generate_chat_completionâ”‚                                      â”‚
â”‚  â”‚  â”œâ”€ temperature: 0.2               â”‚                                      â”‚
â”‚  â”‚  â”œâ”€ max_tokens: 1024               â”‚                                      â”‚
â”‚  â”‚  â””â”€ llm_latency_ms ì¸¡ì •            â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 10-11: ë‹µë³€ ê²€ì¦ (Phase 39)                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AnswerGuardService                                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ validate_citation()      â†’ "ì œNì¡°" ì¸ìš© ê²€ì¦ (RAG ì†ŒìŠ¤ ëŒ€ì¡°)       â”‚  â”‚
â”‚  â”‚  â””â”€ enforce_korean_output()  â†’ ì¤‘êµ­ì–´ í˜¼ìš© ì°¨ë‹¨, í•œê¸€ ê°•ì œ            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 12: PII ë§ˆìŠ¤í‚¹ (OUTPUT)                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  PiiService.detect_and_mask()      â”‚                                      â”‚
â”‚  â”‚  Stage: MaskingStage.OUTPUT        â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 13: Guardrail ì ìš©                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  GuardrailService.apply_to_answer()â”‚                                      â”‚
â”‚  â”‚  â”œâ”€ ì—­í• ë³„ prefix ì¶”ê°€             â”‚                                      â”‚
â”‚  â”‚  â””â”€ ë„ë©”ì¸ë³„ ì•ˆë‚´ ë¬¸êµ¬             â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 14: ë©”íƒ€ë°ì´í„° ì¡°ë¦½                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ChatAnswerMeta                                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ route, intent, domain                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ rag_used, rag_source_count                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ latency_ms, rag_latency_ms, llm_latency_ms, backend_latency_ms    â”‚  â”‚
â”‚  â”‚  â”œâ”€ has_pii_input, has_pii_output, masked                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ error_type, error_message, fallback_reason                        â”‚  â”‚
â”‚  â”‚  â””â”€ rag_gap_candidate (Phase 14)                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 15: AI ë¡œê·¸ ì „ì†¡ (ë¹„ë™ê¸°)                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  AILogService.send_log_async()     â”‚  â—€â”€â”€ asyncio.create_task()          â”‚
â”‚  â”‚  â””â”€ Fire-and-forget ë°©ì‹           â”‚      (Non-blocking)                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 16: ì‘ë‹µ ë°˜í™˜                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ChatResponse                                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ answer: str (ìµœì¢… ë‹µë³€)                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ sources: List[ChatSource] (RAG ë¬¸ì„œ ëª©ë¡)                         â”‚  â”‚
â”‚  â”‚  â””â”€ meta: ChatAnswerMeta                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Route íƒ€ì…ë³„ ë°ì´í„° íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ROUTE TYPE FLOW                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚  RAG_INTERNAL   â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ RagflowClient      â”‚â”€â”€â”€â–¶â”‚ RAG ë¬¸ì„œ    â”‚â”€â”€â”€â–¶â”‚ LLMClient   â”‚â”€â”€â”€â–¶ ë‹µë³€     â”‚
â”‚  â”‚ (ê²€ìƒ‰)             â”‚    â”‚ (context)   â”‚    â”‚ (ìƒì„±)      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚  BACKEND_API    â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ BackendDataClient  â”‚â”€â”€â”€â–¶â”‚ ìš´ì˜ ë°ì´í„° â”‚â”€â”€â”€â–¶â”‚ LLMClient   â”‚â”€â”€â”€â–¶ ë‹µë³€     â”‚
â”‚  â”‚ (API í˜¸ì¶œ)         â”‚    â”‚ (context)   â”‚    â”‚ (ìƒì„±)      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚  â”‚ MIXED_BACKEND_RAG â”‚                                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚           â”‚                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  (ë³‘ë ¬ ì‹¤í–‰)                                              â”‚
â”‚     â–¼           â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚  â”‚RAGFlow â”‚  â”‚BackendClient â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚      â”‚              â”‚                                                       â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚             â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ RAG + Backend í†µí•©  â”‚â”€â”€â”€â–¶â”‚ LLMClient   â”‚â”€â”€â”€â–¶ ë‹µë³€                       â”‚
â”‚  â”‚ (context)           â”‚    â”‚ (ìƒì„±)      â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚    LLM_ONLY     â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ LLMClient (context ì—†ì´ ì§ì ‘ ìƒì„±)      â”‚â”€â”€â”€â–¶ ë‹µë³€                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ì—­í• Ã—ë„ë©”ì¸â†’Route ë§¤í•‘

| User Role | Domain | Intent | Route Type |
|-----------|--------|--------|------------|
| **EMPLOYEE** | POLICY | POLICY_QA | RAG_INTERNAL |
| | INCIDENT | INCIDENT_REPORT | BACKEND_API |
| | INCIDENT | INCIDENT_QA | RAG_INTERNAL |
| | EDUCATION | EDU_STATUS | BACKEND_API |
| | EDUCATION | EDUCATION_QA | RAG_INTERNAL |
| **ADMIN** | POLICY | POLICY_QA | RAG_INTERNAL |
| | INCIDENT | INCIDENT_QA | MIXED_BACKEND_RAG |
| | EDUCATION | EDU_STATUS | MIXED_BACKEND_RAG |
| **INCIDENT_MANAGER** | INCIDENT | * | MIXED_BACKEND_RAG |
| | POLICY/EDU | * | RAG_INTERNAL |
| **ALL** | GENERAL | GENERAL_CHAT | LLM_ONLY |

---

## 6. í•µì‹¬ íŒŒì¼ êµ¬ì¡°

```
app/
â”œâ”€â”€ api/v1/
â”‚   â”œâ”€â”€ chat.py              â† POST /ai/chat/messages ì—”ë“œí¬ì¸íŠ¸
â”‚   â””â”€â”€ chat_stream.py       â† POST /ai/chat/stream ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ chat_service.py      â† ë©”ì¸ ChatService (16ë‹¨ê³„ íŒŒì´í”„ë¼ì¸)
â”‚   â”œâ”€â”€ chat_stream_service.py â† ìŠ¤íŠ¸ë¦¬ë° ChatStreamService
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/                â† ChatService ëª¨ë“ˆ ë¶„ë¦¬
â”‚   â”‚   â”œâ”€â”€ rag_handler.py       â† RAG ê²€ìƒ‰ ë‹´ë‹¹
â”‚   â”‚   â”œâ”€â”€ backend_handler.py   â† Backend API í˜¸ì¶œ ë‹´ë‹¹
â”‚   â”‚   â”œâ”€â”€ message_builder.py   â† LLM í”„ë¡¬í”„íŠ¸ ë¹Œë“œ
â”‚   â”‚   â”œâ”€â”€ response_factory.py  â† ì‘ë‹µ/í´ë°± ìƒì„±
â”‚   â”‚   â””â”€â”€ route_mapper.py      â† Route íƒ€ì… ë³€í™˜
â”‚   â”‚
â”‚   â”œâ”€â”€ intent_service.py    â† í‚¤ì›Œë“œ ê¸°ë°˜ Intent ë¶„ë¥˜
â”‚   â”œâ”€â”€ pii_service.py       â† PII ë§ˆìŠ¤í‚¹ (INPUT/OUTPUT/LOG)
â”‚   â”œâ”€â”€ guardrail_service.py â† ì—­í• ë³„ Guardrail ì ìš©
â”‚   â”œâ”€â”€ answer_guard_service.py â† Phase 39 ë‹µë³€ ê²€ì¦
â”‚   â”œâ”€â”€ ai_log_service.py    â† ë¡œê¹… ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ router_orchestrator.py â† Phase 22 ë¼ìš°í„° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°
â”‚   â”œâ”€â”€ rule_router.py       â† ê·œì¹™ ê¸°ë°˜ ë¼ìš°í„°
â”‚   â””â”€â”€ llm_router.py        â† LLM ê¸°ë°˜ ë¼ìš°í„°
â”‚
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ chat.py              â† ChatRequest, ChatResponse, ChatSource, ChatAnswerMeta
â”‚   â”œâ”€â”€ chat_stream.py       â† ChatStreamRequest, Stream Events
â”‚   â”œâ”€â”€ router_types.py      â† Tier0Intent, SubIntentId, RouterResult
â”‚   â””â”€â”€ personalization.py   â† PersonalizationSubIntentId (Q1-Q20)
â”‚
â””â”€â”€ main.py                  â† FastAPI ì•±, ë¼ìš°í„° ë“±ë¡
```

---

## 7. ìŠ¤íŠ¸ë¦¬ë° íŒŒì´í”„ë¼ì¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /ai/chat/stream                                                       â”‚
â”‚  ChatStreamRequest (ChatRequest + request_id)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  InFlightTracker                                                            â”‚
â”‚  â”œâ”€ ì¤‘ë³µ ìš”ì²­ ì²´í¬ (request_id ê¸°ì¤€)                                        â”‚
â”‚  â”œâ”€ TTL: 600ì´ˆ (10ë¶„)                                                       â”‚
â”‚  â””â”€ ì´ë¯¸ ì§„í–‰ ì¤‘ â†’ ìºì‹œëœ ì‘ë‹µ ë°˜í™˜                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NDJSON Stream Response                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ {"type":"meta","request_id":"...","model":"...","timestamp":"..."}  â”‚    â”‚
â”‚  â”‚ {"type":"token","text":"ì•ˆë…•"}                                      â”‚    â”‚
â”‚  â”‚ {"type":"token","text":"í•˜ì„¸ìš”"}                                    â”‚    â”‚
â”‚  â”‚ {"type":"token","text":"!"}                                         â”‚    â”‚
â”‚  â”‚ ...                                                                 â”‚    â”‚
â”‚  â”‚ {"type":"done","finish_reason":"stop","total_tokens":N,"elapsed_ms":M}â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚  ì—ëŸ¬ ë°œìƒ ì‹œ:                                                              â”‚
â”‚  {"type":"error","code":"UPSTREAM_ERROR","message":"...","request_id":"..."}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Stream Event Types

| Event | ë°œìƒ ì‹œì  | í•„ë“œ |
|-------|----------|------|
| `meta` | ìŠ¤íŠ¸ë¦¼ ì‹œì‘ (1íšŒ) | request_id, model, timestamp |
| `token` | í† í° ìƒì„± (ë‹¤ìˆ˜) | text (delta) |
| `done` | ì„±ê³µ ì¢…ë£Œ (1íšŒ) | finish_reason, total_tokens, elapsed_ms, ttfb_ms |
| `error` | ì—ëŸ¬ ë°œìƒ (1íšŒ) | code, message, request_id |

---

## 8. ë‹¨ê³„ë³„ ë°ì´í„° ë³€í™˜ ìƒì„¸

### ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤
> **ì‚¬ìš©ì**: "í™ê¸¸ë™(010-1234-5678) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"
> **ì—­í• **: EMPLOYEE

---

### STEP 1: HTTP ìš”ì²­ ìˆ˜ì‹ 

```
ğŸ“¥ INPUT: Raw HTTP JSON Body (~280 bytes)
{
  "session_id": "sess-abc123",
  "user_id": "emp-001",
  "user_role": "EMPLOYEE",
  "department": "ê°œë°œíŒ€",
  "domain": null,
  "channel": "WEB",
  "messages": [
    {"role": "user", "content": "í™ê¸¸ë™(010-1234-5678) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"}
  ]
}

ğŸ“¤ OUTPUT: ChatRequest (Pydantic ëª¨ë¸)
ChatRequest(
  session_id="sess-abc123",
  user_id="emp-001",
  user_role="EMPLOYEE",
  department="ê°œë°œíŒ€",
  domain=None,
  channel="WEB",
  messages=[ChatMessage(role="user", content="í™ê¸¸ë™(010-1234-5678)...")]
)
```

---

### STEP 2: ì¿¼ë¦¬ ì¶”ì¶œ

```
ğŸ“¥ INPUT: ChatRequest.messages
[ChatMessage(role="user", content="í™ê¸¸ë™(010-1234-5678)...")]

ğŸ“¤ OUTPUT: user_query (str)
"í™ê¸¸ë™(010-1234-5678) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"

ğŸ“ SIZE: List[1] â†’ str (34ì)
```

---

### STEP 3: PII ë§ˆìŠ¤í‚¹ (INPUT)

```
ğŸ“¥ INPUT
text: "í™ê¸¸ë™(010-1234-5678) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"
stage: MaskingStage.INPUT

ğŸ”„ HTTP í˜¸ì¶œ (PII ì„œë¹„ìŠ¤)
POST http://pii-service:8003/mask
{"text": "í™ê¸¸ë™(010-1234-5678) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜", "stage": "input"}

ğŸ“¤ OUTPUT: PiiMaskResult
PiiMaskResult(
  original_text="í™ê¸¸ë™(010-1234-5678) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜",
  masked_text="[PERSON]([PHONE]) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜",
  has_pii=True,
  tags=[
    PiiTag(entity="í™ê¸¸ë™", label="PERSON", start=0, end=3),
    PiiTag(entity="010-1234-5678", label="PHONE", start=4, end=17)
  ]
)

ğŸ“ SIZE: str (34ì) â†’ PiiMaskResult (4ê°œ í•„ë“œ, tags: 2ê°œ)
```

---

### STEP 5: Intent ë¶„ë¥˜

```
ğŸ“¥ INPUT
req: ChatRequest(user_role="EMPLOYEE", domain=None, ...)
user_query: "[PERSON]([PHONE]) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"

ğŸ”„ ì²˜ë¦¬ ë‹¨ê³„
Step 1: UserRole íŒŒì‹±
  "EMPLOYEE" â†’ UserRole.EMPLOYEE

Step 2: ë„ë©”ì¸ íŒíŠ¸ íŒŒì‹±
  domain=None â†’ domain_hint=None

Step 3: í‚¤ì›Œë“œ ë§¤ì¹­
  query_lower = "[person]([phone]) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"
  âœ— INCIDENT_REPORT_KEYWORDS: "ì‹ ê³ ", "ë³´ê³ " ë“± â†’ ë¯¸ë§¤ì¹­
  âœ— INCIDENT_QA_KEYWORDS: "ì‚¬ê³ ", "ìœ ì¶œ" ë“± â†’ ë¯¸ë§¤ì¹­
  âœ— EDU_STATUS_KEYWORDS: "ìˆ˜ë£Œ", "ì¼ì •" ë“± â†’ ë¯¸ë§¤ì¹­
  âœ— EDU_CONTENT_KEYWORDS: "êµìœ¡", "í›ˆë ¨" ë“± â†’ ë¯¸ë§¤ì¹­
  âœ“ POLICY_KEYWORDS: "ì—°ì°¨", "ê·œì •" â†’ ë§¤ì¹­!
  â†’ IntentType.POLICY_QA, Domain.POLICY

Step 4: ë¼ìš°íŒ… ê²°ì • (EMPLOYEE Ã— POLICY Ã— POLICY_QA)
  â†’ RouteType.RAG_INTERNAL

ğŸ“¤ OUTPUT: IntentResult
IntentResult(
  user_role=UserRole.EMPLOYEE,
  intent=IntentType.POLICY_QA,
  domain="POLICY",
  route=RouteType.RAG_INTERNAL
)

ğŸ“ SIZE: (ChatRequest, str) â†’ IntentResult (4ê°œ í•„ë“œ)
```

---

### STEP 6: RAG ê²€ìƒ‰

```
ğŸ“¥ INPUT
query: "[PERSON]([PHONE]) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"
domain: "POLICY"
top_k: 5

ğŸ”„ RAGFlow HTTP í˜¸ì¶œ
POST http://ragflow:9380/api/v1/retrieval
{"question": "...", "datasets": ["POLICY"], "top_k": 5}

ğŸ“¤ OUTPUT: List[ChatSource]
sources = [
  ChatSource(
    doc_id="doc-001",
    title="ì—°ì°¨íœ´ê°€ ê´€ë¦¬ ê·œì •",
    page=3,
    score=0.92,
    snippet="ì œ10ì¡° (ì—°ì°¨ ì´ì›”) â‘  ì—°ì°¨íœ´ê°€ëŠ” ì›ì¹™ì ìœ¼ë¡œ í•´ë‹¹ ì—°ë„...",
    article_label="ì œ10ì¡° (ì—°ì°¨ ì´ì›”) ì œ2í•­",
    article_path="ì œ3ì¥ > ì œ10ì¡° > ì œ2í•­",
    source_type="POLICY"
  ),
  ChatSource(...),  # 4ê°œ ë”
]

ğŸ“ SIZE: (str, str, ChatRequest) â†’ List[ChatSourceÃ—5] (~2KB)
```

---

### STEP 8: LLM ë©”ì‹œì§€ ë¹Œë“œ

```
ğŸ“¥ INPUT
user_query: "[PERSON]([PHONE]) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"
sources: [ChatSourceÃ—5]
user_role: UserRole.EMPLOYEE
domain: "POLICY"
intent: IntentType.POLICY_QA

ğŸ”„ ì²˜ë¦¬ ë‹¨ê³„
1. Guardrail Prefix ìƒì„±
2. Sources â†’ í…ìŠ¤íŠ¸ í¬ë§·íŒ… (format_sources_for_prompt)
3. System Prompt ì¡°í•©

ğŸ“¤ OUTPUT: List[Dict[str, str]]
[
  {
    "role": "system",
    "content": """
      [ì•ˆë‚´] ì¼ë°˜ ì§ì›ìœ¼ë¡œì„œ ì§ˆë¬¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...

      ë‹¹ì‹ ì€ íšŒì‚¬ ë‚´ë¶€ ì •ë³´ë³´í˜¸ ë° ì‚¬ê·œë¥¼ ì•ˆë‚´í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸...

      ì°¸ê³  ë¬¸ì„œ:
      [ê·¼ê±° 1]
      - ë¬¸ì„œ: ì—°ì°¨íœ´ê°€ ê´€ë¦¬ ê·œì • (p.3)
      - ìœ„ì¹˜: ì œ3ì¥ > ì œ10ì¡° > ì œ2í•­
      - ê´€ë ¨ë„: 0.92
      - ë‚´ìš©: ì œ10ì¡° (ì—°ì°¨ ì´ì›”) â‘  ì—°ì°¨íœ´ê°€ëŠ”...
      ...
    """
  },
  {
    "role": "user",
    "content": "[PERSON]([PHONE]) ì—°ì°¨ ì´ì›” ê·œì • ì•Œë ¤ì¤˜"
  }
]

ğŸ“ SIZE: (str, List[5], Enums) â†’ List[DictÃ—2] (~3KB)
```

---

### STEP 9: LLM í˜¸ì¶œ

```
ğŸ“¥ INPUT
messages: [{"role": "system", ...}, {"role": "user", ...}]
temperature: 0.2
max_tokens: 1024

ğŸ”„ HTTP í˜¸ì¶œ (LLM ì„œë¹„ìŠ¤)
POST http://llm-service:8080/v1/chat/completions

ğŸ“¤ OUTPUT: raw_answer (str)
"""
ì—°ì°¨íœ´ê°€ ì´ì›” ê·œì •ì— ëŒ€í•´ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

**ì—°ì°¨ ì´ì›” ê¸°ë³¸ ì›ì¹™**
ì—°ì°¨íœ´ê°€ ê´€ë¦¬ ê·œì • ì œ10ì¡°ì— ë”°ë¥´ë©´, ì—°ì°¨íœ´ê°€ëŠ” ì›ì¹™ì ìœ¼ë¡œ í•´ë‹¹
ì—°ë„ ë‚´ì— ì‚¬ìš©í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë§Œ, ì—…ë¬´ìƒ ë¶ˆê°€í”¼í•œ ì‚¬ìœ ê°€ ìˆëŠ”
ê²½ìš° ë‹¤ìŒ ì—°ë„ë¡œ ì´ì›”ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ì´ì›” í•œë„**
- ìµœëŒ€ 5ì¼ê¹Œì§€ ë‹¤ìŒ ì—°ë„ë¡œ ì´ì›” ê°€ëŠ¥
- ì´ì›”ëœ ì—°ì°¨ëŠ” ë‹¤ìŒ ì—°ë„ ìƒë°˜ê¸°(6ì›” 30ì¼)ê¹Œì§€ ì‚¬ìš©í•´ì•¼ í•¨

[ì°¸ê³  ê·¼ê±°]
- ì—°ì°¨íœ´ê°€ ê´€ë¦¬ ê·œì • ì œ10ì¡° (ì—°ì°¨ ì´ì›”) ì œ2í•­
- ì¸ì‚¬ê´€ë¦¬ ê·œì • ì œ15ì¡° (íœ´ê°€ ì¼ìˆ˜ ì‚°ì •)
"""

ğŸ“ SIZE: List[DictÃ—2] â†’ str (~600ì)
â±ï¸ llm_latency_ms: ~1200ms
```

---

### STEP 14: ë©”íƒ€ë°ì´í„° ì¡°ë¦½

```
ğŸ“¥ INPUT (ìˆ˜ì§‘ëœ ëª¨ë“  ë°ì´í„°)
user_role: UserRole.EMPLOYEE
intent: IntentType.POLICY_QA
domain: "POLICY"
route: RouteType.RAG_INTERNAL
pii_input.has_pii: True
pii_output.has_pii: False
sources: [ChatSourceÃ—5]
latency_ms: 1850
rag_latency_ms: 450
llm_latency_ms: 1200
rag_max_score: 0.92

ğŸ“¤ OUTPUT: ChatAnswerMeta
ChatAnswerMeta(
  user_role="EMPLOYEE",
  used_model="internal-llm",
  route="RAG_INTERNAL",
  intent="POLICY_QA",
  domain="POLICY",
  masked=True,
  has_pii_input=True,
  has_pii_output=False,
  rag_used=True,
  rag_source_count=5,
  latency_ms=1850,
  error_type=None,
  error_message=None,
  fallback_reason=None,
  rag_latency_ms=450,
  llm_latency_ms=1200,
  backend_latency_ms=None,
  rag_gap_candidate=False
)

ğŸ“ SIZE: ì—¬ëŸ¬ ë³€ìˆ˜ â†’ ChatAnswerMeta (17ê°œ í•„ë“œ)
```

---

### STEP 16: ìµœì¢… ì‘ë‹µ ë°˜í™˜

```
ğŸ“¤ OUTPUT: ChatResponse
ChatResponse(
  answer="ì—°ì°¨íœ´ê°€ ì´ì›” ê·œì •ì— ëŒ€í•´ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤...",

  sources=[
    ChatSource(
      doc_id="doc-001",
      title="ì—°ì°¨íœ´ê°€ ê´€ë¦¬ ê·œì •",
      page=3,
      score=0.92,
      snippet="ì œ10ì¡° (ì—°ì°¨ ì´ì›”) â‘ ...",
      article_label="ì œ10ì¡° (ì—°ì°¨ ì´ì›”) ì œ2í•­",
      article_path="ì œ3ì¥ > ì œ10ì¡° > ì œ2í•­",
      source_type="POLICY"
    ),
    ...  # 4ê°œ ë”
  ],

  meta=ChatAnswerMeta(
    user_role="EMPLOYEE",
    route="RAG_INTERNAL",
    intent="POLICY_QA",
    domain="POLICY",
    masked=True,
    has_pii_input=True,
    has_pii_output=False,
    rag_used=True,
    rag_source_count=5,
    latency_ms=1850,
    rag_latency_ms=450,
    llm_latency_ms=1200,
    rag_gap_candidate=False
  )
)

â†’ HTTP JSON ì‘ë‹µìœ¼ë¡œ ì§ë ¬í™” (~4KB)
```

---

## 9. ë°ì´í„° í¬ê¸° ë³€í™” ìš”ì•½

| Step | ë°ì´í„° íƒ€ì… | ëŒ€ëµì  í¬ê¸° | ì£¼ìš” ë³€í™˜ |
|------|------------|------------|----------|
| 1 | HTTP JSON â†’ ChatRequest | 280B â†’ obj | íŒŒì‹±/ê²€ì¦ |
| 2 | List[Msg] â†’ str | 1ê°œ â†’ 34ì | ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì¶”ì¶œ |
| 3 | str â†’ PiiMaskResult | 34ì â†’ 32ì | PII 2ê°œ ë§ˆìŠ¤í‚¹ |
| 4 | str â†’ None | 32ì â†’ 0 | ë¯¼ì› ì²´í¬ (í†µê³¼) |
| 5 | (Req, str) â†’ IntentResult | ë‹¤ìˆ˜ â†’ 4í•„ë“œ | í‚¤ì›Œë“œ â†’ Enum ë³€í™˜ |
| 6 | (str, str) â†’ List[SrcÃ—5] | ì¿¼ë¦¬ â†’ 2KB | RAG ê²€ìƒ‰ (5ë¬¸ì„œ) |
| 7 | (Enum, List) â†’ (bool, -) | ì²´í¬ë§Œ | ë‹µë³€ê°€ëŠ¥ ì—¬ë¶€ íŒì • |
| 8 | (str, List) â†’ List[Dict] | â†’ 3KB | í”„ë¡¬í”„íŠ¸ ì¡°í•© |
| 9 | List[Dict] â†’ str | 3KB â†’ 600ì | LLM ì‘ë‹µ ìƒì„± |
| 10-11 | str â†’ (bool, str) | 600ì ìœ ì§€ | ê²€ì¦ë§Œ (ë³€í™˜ ì—†ìŒ) |
| 12 | str â†’ PiiMaskResult | 600ì ìœ ì§€ | OUTPUT PII (ì—†ìŒ) |
| 13 | str â†’ str | 600ì ìœ ì§€ | Prefix ì ìš© (ì—†ìŒ) |
| 14 | ë‹¤ìˆ˜ ë³€ìˆ˜ â†’ Meta | â†’ 17í•„ë“œ | ë©”íƒ€ë°ì´í„° ì§‘ê³„ |
| 15 | (ë¹„ë™ê¸° ë¶„ë¦¬) | - | ë¡œê·¸ ì „ì†¡ |
| 16 | (str, List, Meta) â†’ Resp | â†’ 4KB | ìµœì¢… ì‘ë‹µ ì¡°í•© |

### ì²˜ë¦¬ ì‹œê°„ ë¶„í¬

```
ì´ ì²˜ë¦¬ ì‹œê°„: ~1850ms
â”œâ”€â”€ RAG ê²€ìƒ‰:  450ms (24%)
â”œâ”€â”€ LLM ìƒì„±: 1200ms (65%)
â””â”€â”€ ê¸°íƒ€ ì²˜ë¦¬: 200ms (11%)
```

---

## ë°ì´í„° íƒ€ì… ë³€í™˜ íë¦„ ìš”ì•½

```
HTTP JSON Body (280B)
      â”‚
      â–¼ [Pydantic ê²€ì¦]
ChatRequest (7 fields)
      â”‚
      â–¼ [ì¶”ì¶œ]
user_query: str (34ì)
      â”‚
      â–¼ [PII ë§ˆìŠ¤í‚¹]
PiiMaskResult { masked_text: str (32ì), has_pii: bool, tags: List[PiiTag] }
      â”‚
      â–¼ [Intent ë¶„ë¥˜]
IntentResult { user_role: Enum, intent: Enum, domain: str, route: Enum }
      â”‚
      â–¼ [RAG ê²€ìƒ‰]
List[ChatSource] (5ê°œ Ã— 8 fields each â‰ˆ 2KB)
      â”‚
      â–¼ [ë©”ì‹œì§€ ë¹Œë“œ]
List[Dict] = [
  {"role": "system", "content": str (2500ì)},
  {"role": "user", "content": str (32ì)}
]
      â”‚
      â–¼ [LLM í˜¸ì¶œ]
raw_answer: str (600ì)
      â”‚
      â–¼ [ê²€ì¦ + PII OUTPUT]
masked_answer: str (600ì, ë™ì¼)
      â”‚
      â–¼ [ë©”íƒ€ ì¡°ë¦½]
ChatAnswerMeta (17 fields)
      â”‚
      â–¼ [ì‘ë‹µ ì¡°í•©]
ChatResponse {
  answer: str (600ì),
  sources: List[ChatSource] (5ê°œ),
  meta: ChatAnswerMeta (17 fields)
} â‰ˆ 4KB
      â”‚
      â–¼ [JSON ì§ë ¬í™”]
HTTP JSON Response (4KB)
```

---

## 10. ì¸í…íŠ¸ ì²´ê³„ (Tier-0 + Sub-Intent)

ì‹œìŠ¤í…œì—ëŠ” **ë‘ ê³„ì¸µì˜ ì¸í…íŠ¸ ì‹œìŠ¤í…œ**ì´ ìˆìœ¼ë©°, ê°ê° ë‹¤ë¥¸ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### 10.1 ì „ì²´ ì¸í…íŠ¸ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Intent Classification System                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Tier-0 Intent] (6ê°œ ê³ ì •) - ë¼ìš°íŒ… ê²½ë¡œ ê²°ì •                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Tier0Intent      â”‚ ì„¤ëª…                      â”‚ Route Type        â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ POLICY_QA        â”‚ ì‚¬ê·œ/ê·œì •/ì •ì±… Q&A        â”‚ RAG_INTERNAL      â”‚   â”‚
â”‚  â”‚ EDUCATION_QA     â”‚ êµìœ¡ ë‚´ìš©/ê·œì • ì§ˆë¬¸       â”‚ RAG_INTERNAL      â”‚   â”‚
â”‚  â”‚ BACKEND_STATUS   â”‚ ê°œì¸í™” ì¡°íšŒ (HR/ì—°ì°¨ ë“±)  â”‚ BACKEND_API       â”‚   â”‚
â”‚  â”‚ GENERAL_CHAT     â”‚ ì¼ë°˜ ì¡ë‹´                 â”‚ LLM_ONLY          â”‚   â”‚
â”‚  â”‚ SYSTEM_HELP      â”‚ ì‹œìŠ¤í…œ ì‚¬ìš©ë²•             â”‚ ROUTE_SYSTEM_HELP â”‚   â”‚
â”‚  â”‚ UNKNOWN          â”‚ ë¶„ë¥˜ ë¶ˆê°€                 â”‚ ROUTE_UNKNOWN     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  [Sub-Intent ID] (7ê°œ) - ì„¸ë¶€ ì•¡ì…˜ ì‹ë³„                                  â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ SubIntentId        â”‚ ì„¤ëª…               â”‚ íŠ¹ì„±                  â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ QUIZ_START         â”‚ í€´ì¦ˆ ì‹œì‘          â”‚ ğŸ”´ ì¹˜ëª… ì•¡ì…˜ (í™•ì¸í•„ìš”)â”‚    â”‚
â”‚  â”‚ QUIZ_SUBMIT        â”‚ í€´ì¦ˆ ì œì¶œ/ì±„ì      â”‚ ğŸ”´ ì¹˜ëª… ì•¡ì…˜ (í™•ì¸í•„ìš”)â”‚    â”‚
â”‚  â”‚ QUIZ_GENERATION    â”‚ í€´ì¦ˆ ë¬¸í•­ ìƒì„±     â”‚ ğŸ”´ ì¹˜ëª… ì•¡ì…˜ (í™•ì¸í•„ìš”)â”‚    â”‚
â”‚  â”‚ EDU_STATUS_CHECK   â”‚ êµìœ¡ ì´ìˆ˜í˜„í™© ì¡°íšŒ â”‚ ğŸŸ¢ ì¡°íšŒì„±              â”‚    â”‚
â”‚  â”‚ HR_LEAVE_CHECK     â”‚ ì—°ì°¨/íœ´ê°€ ì¡°íšŒ     â”‚ ğŸŸ¢ ì¡°íšŒì„±              â”‚    â”‚
â”‚  â”‚ HR_ATTENDANCE_CHECKâ”‚ ê·¼íƒœ í˜„í™© ì¡°íšŒ     â”‚ ğŸŸ¢ ì¡°íšŒì„±              â”‚    â”‚
â”‚  â”‚ HR_WELFARE_CHECK   â”‚ ë³µì§€ í¬ì¸íŠ¸ ì¡°íšŒ   â”‚ ğŸŸ¢ ì¡°íšŒì„±              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  [Personalization Sub-Intent] (Q1~Q20, 20ê°œ) - ê°œì¸í™” ë°±ì—”ë“œ ì¡°íšŒ        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ID   â”‚ ì„¤ëª…                            â”‚ ë„ë©”ì¸                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Q1 â˜…â”‚ ë¯¸ì´ìˆ˜ í•„ìˆ˜ êµìœ¡ ì¡°íšŒ           â”‚ EDU (ìš°ì„ êµ¬í˜„)          â”‚   â”‚
â”‚  â”‚ Q2   â”‚ ë‚´ êµìœ¡ ìˆ˜ë£Œ í˜„í™© ì¡°íšŒ          â”‚ EDU                     â”‚   â”‚
â”‚  â”‚ Q3 â˜…â”‚ ì´ë²ˆ ë‹¬ ë°ë“œë¼ì¸ í•„ìˆ˜ êµìœ¡      â”‚ EDU (ìš°ì„ êµ¬í˜„)          â”‚   â”‚
â”‚  â”‚ Q4   â”‚ íŠ¹ì • êµìœ¡ ì§„ë„ìœ¨/ì‹œì²­ë¥          â”‚ EDU                     â”‚   â”‚
â”‚  â”‚ Q5 â˜…â”‚ ë‚´ vs ë¶€ì„œ vs ì „ì‚¬ í‰ê·  ë¹„êµ    â”‚ QUIZ (ìš°ì„ êµ¬í˜„)         â”‚   â”‚
â”‚  â”‚ Q6 â˜…â”‚ ê°€ì¥ ë§ì´ í‹€ë¦° ë³´ì•ˆ í† í”½ TOP3   â”‚ QUIZ (ìš°ì„ êµ¬í˜„)         â”‚   â”‚
â”‚  â”‚ Q7   â”‚ íŠ¹ì • êµìœ¡ í€´ì¦ˆ ê²°ê³¼             â”‚ QUIZ                    â”‚   â”‚
â”‚  â”‚ Q8   â”‚ ë‚´ í€´ì¦ˆ ì ìˆ˜ ì´ë ¥               â”‚ QUIZ                    â”‚   â”‚
â”‚  â”‚ Q9 â˜…â”‚ ì´ë²ˆ ì£¼ êµìœ¡/í€´ì¦ˆ í•  ì¼         â”‚ EDU (ìš°ì„ êµ¬í˜„)          â”‚   â”‚
â”‚  â”‚ Q10  â”‚ ë‚´ ê·¼íƒœ í˜„í™©                    â”‚ HR                      â”‚   â”‚
â”‚  â”‚ Q11â˜…â”‚ ë‚¨ì€ ì—°ì°¨ ì¼ìˆ˜                  â”‚ HR (ìš°ì„ êµ¬í˜„)           â”‚   â”‚
â”‚  â”‚ Q12  â”‚ ì—°ì°¨ ì‚¬ìš© ì´ë ¥                  â”‚ HR                      â”‚   â”‚
â”‚  â”‚ Q13  â”‚ ê¸‰ì—¬ ëª…ì„¸ì„œ ìš”ì•½                â”‚ HR                      â”‚   â”‚
â”‚  â”‚ Q14â˜…â”‚ ë³µì§€/ì‹ëŒ€ í¬ì¸íŠ¸ ì”ì•¡           â”‚ HR (ìš°ì„ êµ¬í˜„)           â”‚   â”‚
â”‚  â”‚ Q15  â”‚ ë³µì§€ í¬ì¸íŠ¸ ì‚¬ìš© ë‚´ì—­           â”‚ HR                      â”‚   â”‚
â”‚  â”‚ Q16  â”‚ ë‚´ ì¸ì‚¬ ì •ë³´                    â”‚ HR                      â”‚   â”‚
â”‚  â”‚ Q17  â”‚ ë‚´ íŒ€/ë¶€ì„œ ì •ë³´                 â”‚ HR                      â”‚   â”‚
â”‚  â”‚ Q18  â”‚ ë³´ì•ˆ êµìœ¡ ì´ìˆ˜ í˜„í™©             â”‚ EDU                     â”‚   â”‚
â”‚  â”‚ Q19  â”‚ í•„ìˆ˜ êµìœ¡ ì „ì²´ ìš”ì•½             â”‚ EDU                     â”‚   â”‚
â”‚  â”‚ Q20â˜…â”‚ ì˜¬í•´ HR í•  ì¼ (ë¯¸ì™„ë£Œ)          â”‚ HR (ìš°ì„ êµ¬í˜„)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  â˜… = ë°ëª¨ ì™„ì „ êµ¬í˜„ ëŒ€ìƒ 8ê°œ (PRIORITY_SUB_INTENTS)                      â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 ì¸í…íŠ¸ ê³„ì¸µë³„ ì—­í• 

| ê³„ì¸µ | ê°œìˆ˜ | ì—­í•  | ì½”ë“œ ìœ„ì¹˜ |
|------|------|------|---------|
| **Tier-0 Intent** | 6ê°œ | ë¼ìš°íŒ… ê²½ë¡œ ê²°ì • (RAG/API/LLM) | `router_types.py:41-61` |
| **SubIntentId** | 7ê°œ | ì¹˜ëª… ì•¡ì…˜(3) + ì¡°íšŒì„±(4) êµ¬ë¶„ | `router_types.py:119-143` |
| **PersonalizationSubIntentId** | 20ê°œ | ê°œì¸í™” ë°±ì—”ë“œ ì¡°íšŒ ì„¸ë¶„í™” | `personalization.py:51-99` |

### 10.3 ë¼ìš°íŒ… ë¶„ê¸° ë¡œì§

```
ì‚¬ìš©ì ì…ë ¥: "ë‚´ ì—°ì°¨ ë©°ì¹  ë‚¨ì•˜ì–´?"
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Rule Router or LLM Router                                        â”‚
â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                                       â”‚
â”‚    RouterResult {                                                    â”‚
â”‚      tier0_intent: BACKEND_STATUS,  â—€â”€â”€â”€ Tier-0 (6ê°œ ì¤‘ 1ê°œ)        â”‚
â”‚      domain: HR,                                                     â”‚
â”‚      route_type: BACKEND_API,                                        â”‚
â”‚      sub_intent_id: "HR_LEAVE_CHECK", â—€â”€â”€â”€ Sub-Intent (7ê°œ ì¤‘ 1ê°œ)  â”‚
â”‚      confidence: 0.95,                                               â”‚
â”‚      requires_confirmation: false                                    â”‚
â”‚    }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ì¡°ê±´ ë¶„ê¸° (llm_router.py:368-400)                                â”‚
â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                                â”‚
â”‚                                                                      â”‚
â”‚    if tier0_intent == BACKEND_STATUS and not sub_intent_id:         â”‚
â”‚        â†’ needs_clarify = true  (ë¬´ìŠ¨ ì¡°íšŒì¸ì§€ ëª…í™•í™” í•„ìš”)           â”‚
â”‚                                                                      â”‚
â”‚    if sub_intent_id in CRITICAL_ACTION_SUB_INTENTS:                 â”‚
â”‚        â†’ requires_confirmation = true  (ì¹˜ëª… ì•¡ì…˜ í™•ì¸ ê²Œì´íŠ¸)       â”‚
â”‚        â†’ confirmation_prompt = "í€´ì¦ˆë¥¼ ì‹œì‘í• ê¹Œìš”? (ì˜ˆ/ì•„ë‹ˆì˜¤)"      â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ê°œì¸í™” ì¡°íšŒ (PersonalizationClient)                              â”‚
â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                              â”‚
â”‚                                                                      â”‚
â”‚    sub_intent_id â†’ Q11 (ë‚¨ì€ ì—°ì°¨ ì¼ìˆ˜)ë¡œ ë§¤í•‘                       â”‚
â”‚                                                                      â”‚
â”‚    POST /api/personalization/resolve                                 â”‚
â”‚    {                                                                 â”‚
â”‚      "sub_intent_id": "Q11",                                         â”‚
â”‚      "period": "this-year"                                           â”‚
â”‚    }                                                                 â”‚
â”‚                                                                      â”‚
â”‚    Response (Facts):                                                 â”‚
â”‚    {                                                                 â”‚
â”‚      "sub_intent_id": "Q11",                                         â”‚
â”‚      "metrics": { "remaining_days": 12 },                            â”‚
â”‚      "items": []                                                     â”‚
â”‚    }                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.4 ì¹˜ëª… ì•¡ì…˜ vs ì¡°íšŒì„± ì•¡ì…˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Sub-Intent ì²˜ë¦¬ ë¶„ê¸°                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  CRITICAL_ACTION_SUB_INTENTS (3ê°œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
â”‚  â€¢ QUIZ_START                                                        â”‚
â”‚  â€¢ QUIZ_SUBMIT          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â€¢ QUIZ_GENERATION      â”‚ requires_confirmation = true        â”‚     â”‚
â”‚                         â”‚ confirmation_prompt = "...í• ê¹Œìš”?"  â”‚     â”‚
â”‚                         â”‚ â†’ ì‚¬ìš©ì í™•ì¸ í›„ ì§„í–‰               â”‚     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                       â”‚
â”‚  ì¡°íšŒì„± Sub-Intent (4ê°œ + Q1~Q20) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
â”‚  â€¢ EDU_STATUS_CHECK                                                  â”‚
â”‚  â€¢ HR_LEAVE_CHECK       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â€¢ HR_ATTENDANCE_CHECK  â”‚ requires_confirmation = false       â”‚     â”‚
â”‚  â€¢ HR_WELFARE_CHECK     â”‚ â†’ ë°”ë¡œ ë°±ì—”ë“œ API í˜¸ì¶œ              â”‚     â”‚
â”‚  â€¢ Q1~Q20               â”‚ â†’ Facts ê¸°ë°˜ ë‹µë³€ ìƒì„±              â”‚     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.5 Tier0Intent â†’ RouteType ê¸°ë³¸ ë§¤í•‘

`router_types.py:294-302`ì— ì •ì˜ëœ TIER0_ROUTING_POLICY:

| Tier0Intent | RouteType | Domain |
|-------------|-----------|--------|
| POLICY_QA | RAG_INTERNAL | POLICY |
| EDUCATION_QA | RAG_INTERNAL | EDU |
| BACKEND_STATUS | BACKEND_API | HR (contextì— ë”°ë¼ HR/QUIZ/EDU) |
| GENERAL_CHAT | LLM_ONLY | GENERAL |
| SYSTEM_HELP | ROUTE_SYSTEM_HELP | GENERAL |
| UNKNOWN | ROUTE_UNKNOWN | GENERAL |

### 10.6 ë°ëª¨ ìš°ì„ êµ¬í˜„ ëŒ€ìƒ (8ê°œ)

`personalization.py:103-112`ì— ì •ì˜ëœ PRIORITY_SUB_INTENTS:

| ID | ì„¤ëª… | ë„ë©”ì¸ | ê¸°ë³¸ ê¸°ê°„ |
|----|------|--------|----------|
| Q1 | ë¯¸ì´ìˆ˜ í•„ìˆ˜ êµìœ¡ ì¡°íšŒ | EDU | - |
| Q3 | ì´ë²ˆ ë‹¬ ë°ë“œë¼ì¸ í•„ìˆ˜ êµìœ¡ | EDU | this-month |
| Q5 | ë‚´ vs ë¶€ì„œ vs ì „ì‚¬ í‰ê·  ë¹„êµ | QUIZ | this-year |
| Q6 | ê°€ì¥ ë§ì´ í‹€ë¦° ë³´ì•ˆ í† í”½ TOP3 | QUIZ | 3m |
| Q9 | ì´ë²ˆ ì£¼ êµìœ¡/í€´ì¦ˆ í•  ì¼ | EDU | this-week |
| Q11 | ë‚¨ì€ ì—°ì°¨ ì¼ìˆ˜ | HR | this-year |
| Q14 | ë³µì§€/ì‹ëŒ€ í¬ì¸íŠ¸ ì”ì•¡ | HR | this-year |
| Q20 | ì˜¬í•´ HR í•  ì¼ (ë¯¸ì™„ë£Œ) | HR | this-year |

---

## ë¶€ë¡: ê´€ë ¨ ì½”ë“œ íŒŒì¼ ì°¸ì¡°

| íŒŒì¼ | ì—­í•  | í•µì‹¬ í•¨ìˆ˜/í´ë˜ìŠ¤ |
|------|------|----------------|
| `app/api/v1/chat.py` | HTTP ì—”ë“œí¬ì¸íŠ¸ | `create_chat_message()` |
| `app/services/chat_service.py` | ë©”ì¸ íŒŒì´í”„ë¼ì¸ | `ChatService.handle_chat()` |
| `app/services/pii_service.py` | PII ë§ˆìŠ¤í‚¹ | `PiiService.detect_and_mask()` |
| `app/services/intent_service.py` | Intent ë¶„ë¥˜ | `IntentService.classify()` |
| `app/services/chat/rag_handler.py` | RAG ê²€ìƒ‰ | `RagHandler.perform_search_with_fallback()` |
| `app/services/chat/message_builder.py` | LLM í”„ë¡¬í”„íŠ¸ | `MessageBuilder.build_rag_messages()` |
| `app/services/answer_guard_service.py` | ë‹µë³€ ê²€ì¦ | `AnswerGuardService` |
| `app/models/chat.py` | ë°ì´í„° ëª¨ë¸ | `ChatRequest`, `ChatResponse`, `ChatAnswerMeta` |
| `app/models/intent.py` | Intent/Route Enum | `IntentType`, `RouteType`, `UserRole` |
| `app/models/router_types.py` | Router íƒ€ì… ì •ì˜ | `Tier0Intent`, `SubIntentId`, `RouterResult` |
| `app/models/personalization.py` | ê°œì¸í™” ëª¨ë¸ | `PersonalizationSubIntentId` (Q1-Q20) |
| `app/services/rule_router.py` | ê·œì¹™ ê¸°ë°˜ ë¼ìš°í„° | í‚¤ì›Œë“œ ë§¤ì¹­ â†’ RouterResult |
| `app/services/llm_router.py` | LLM ê¸°ë°˜ ë¼ìš°í„° | LLM JSON íŒŒì‹± â†’ RouterResult |
| `app/services/router_orchestrator.py` | ë¼ìš°í„° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° | rule_router â†’ llm_router â†’ clarify/confirm |
| `app/clients/personalization_client.py` | ê°œì¸í™” í´ë¼ì´ì–¸íŠ¸ | sub_intent_id â†’ Backend API í˜¸ì¶œ |
