# =============================================================================
# Fluent Bit Configuration for ctrlf-ai
# Docker 컨테이너 로그 수집 → Elasticsearch (Rollover Alias 사용)
# =============================================================================

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  /fluent-bit/etc/parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# =============================================================================
# INPUT: Docker 컨테이너 로그 읽기 (Linux/EC2)
# /var/lib/docker/containers/*/*.log 에서 JSON wrapper 형태로 읽음
# =============================================================================
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Tag               docker.*
    Parser            docker
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    DB                /fluent-bit/db/docker-logs.db

# =============================================================================
# FILTER 1: 우리 JSON 로그만 필터링
# @timestamp 필드가 있는 로그만 통과 (ES/Kibana 등 텍스트 로그 제외)
# =============================================================================
[FILTER]
    Name          grep
    Match         docker.*
    Regex         log .*"@timestamp":

# =============================================================================
# FILTER 2: JSON 2차 파싱
# Docker log wrapper: {"log": "{\"@timestamp\":...,\"level\":...}", "stream": "stdout", "time": "..."}
# log 필드 안의 앱 JSON을 파싱하여 최상위 필드로 추출
# =============================================================================
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        json_log
    Reserve_Data  Off

# =============================================================================
# FILTER 3: 불필요한 Docker 메타데이터 제거
# =============================================================================
[FILTER]
    Name          modify
    Match         docker.*
    Remove        stream
    Remove        time
    Remove        log

# =============================================================================
# OUTPUT: Elasticsearch Rollover Alias로 전송
# ctrlf-ai alias → ctrlf-ai-000001 (ILM이 rollover 관리)
# =============================================================================
[OUTPUT]
    Name            es
    Match           docker.*
    Host            elasticsearch
    Port            9200
    # Rollover alias 사용 (setup-elasticsearch.sh에서 생성)
    Index           ctrlf-ai
    # @timestamp를 ES time field로 사용
    Time_Key        @timestamp
    Time_Key_Format %Y-%m-%dT%H:%M:%S.%LZ
    # Logstash_Format Off: alias에 직접 쓰기 (ILM rollover 사용)
    Logstash_Format Off
    # ID 중복 방지
    Generate_ID     On
    # 재시도 설정
    Retry_Limit     5
    # TLS 비활성화 (개발 환경, 프로덕션은 On)
    tls             Off
    # 버퍼링
    Buffer_Size     512KB
    # 타입 (ES 8.x에서는 무시됨)
    Type            _doc
    # Suppress_Type_Name On (ES 8.x 권장)
    Suppress_Type_Name On
