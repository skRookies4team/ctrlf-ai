응, 이제 ChatService 통합 들어가면 돼. 다만 지금 로그를 보면 app/services/forbidden_query_filter.py가 “설명 주석 1줄”만 써진 상태라서(Write 1 lines), **Step 1은 ‘필터 서비스 파일을 실제 구현 + ChatService에 1차 가드로 연결’**로 잡는 게 맞아.

아래는 **Step 1용 Claude Code 프롬프트(간단명료)**야.

Step 1 — Claude Code 프롬프트
목표: 금지질문 룰셋(JSON)을 런타임에 로드해서, ChatService에서 PII 마스킹 전에 raw_query로 금지질문 체크 → RAG(Milvus/RAGFlow) 호출을 “절대” 만들지 않고 즉시 대체 응답을 반환한다. (일단 ChatService만, FaqService/2차가드는 Step 2+)

작업 지시
app/services/forbidden_query_filter.py를 “실제 동작하는 코드”로 완성해라.

입력 룰셋: app/resources/forbidden_queries/forbidden_ruleset.{A|B}.json + forbidden_ruleset.manifest.json

로드 시 로그: ForbiddenRuleset loaded: version=..., profile=..., rules=...

ForbiddenQueryResult(dataclass 또는 pydantic) 포함:

is_forbidden: bool

skip_rag: bool = True

skip_backend_api: bool = False (지금은 기본 False로만 두고, 룰에 있으면 True 가능하게)

reason_code: str

rule_id: str | None

example_response: str | None (엑셀 “대체 응답 예시” 기반)

매칭 방식은 exact match 우선:

정규화 함수 normalize(text) 구현(최소: strip, 다중 공백 1개로, 소문자화)

normalized_query -> rule dict 인덱스 만들어 O(1) 조회

manifest의 version은 반드시 읽어서 로그에 포함.

파일 경로는 Path(__file__) 기준으로 repo 상대경로 안전하게 resolve.

app/core/config.py에 설정 추가

FORBIDDEN_QUERY_FILTER_ENABLED: bool = True

FORBIDDEN_QUERY_PROFILE: str = "A" # "A" or "B"

FORBIDDEN_QUERY_RULESET_DIR: str = "app/resources/forbidden_queries" (또는 코드 내부 상수)

app/services/chat_service.py에 1차 가드 삽입

위치: chat()에서 PII 마스킹 호출 전에 raw_query = req.question으로 체크

if settings.FORBIDDEN_QUERY_FILTER_ENABLED: result = forbidden_filter.check(raw_query)

if result.is_forbidden: 이면

RAG 검색 함수/태스크 생성 금지

즉시 ChatResponse 반환 (sources는 빈 리스트)

응답 본문은 result.example_response가 있으면 그걸 사용하고, 없으면 안전한 기본 문구 사용

debug_info에 retrieval_skipped=True, retrieval_skip_reason="FORBIDDEN_QUERY", matched_rule_id, ruleset_version 기록(필드가 없으면 최소한 로그라도 남기기)

최소 테스트 1개 추가

tests/unit/test_forbidden_query_chatservice.py 신규

금지질문 1개를 넣고 MilvusSearchClient.search가 호출되지 않았음을 assert (AsyncMock/patch)

응답 본문이 example_response 또는 기본 문구로 반환되는지 assert

완료 조건
python -m pytest -q에서 새 테스트 포함 PASS

금지질문 입력 시 로그에 ForbiddenRuleset loaded: ... (최초 1회) + “FORBIDDEN_QUERY로 retrieval 스킵” 로그가 남고, RAG 관련 로그가 발생하지 않음

추가로, 너 방금 requirements.txt는 echo로 붙였으니 중복 pandas 라인만 없는지 정도만 나중에 정리하면 돼(동작 자체는 크게 문제 안 생김).